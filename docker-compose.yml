version: '3.9'

networks:
  gh-network:
    driver: bridge

services:
  # === Frontend ===
  frontend:
    build: ./apps/frontend
    container_name: gh-frontend
    ports:
      - "5173:5173"
    networks:
      - gh-network
    command: npm run dev -- --host 0.0.0.0
    env_file: .env

  # === Spring Boot Services ===
  api-gateway:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: api-gateway
    container_name: gh-api-gateway
    ports:
      - "8080:8080"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8080

  auth-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: auth
    container_name: gh-auth
    ports:
      - "8081:8081"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8081

  customer-support-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: customer-support
    container_name: gh-customer-support
    ports:
      - "8088:8088"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8088

  master-data-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: master-data
    container_name: gh-master-data
    ports:
      - "8085:8085"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8085

  inventory-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: inventory
    container_name: gh-inventory
    ports:
      - "8084:8084"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8084

  sales-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: sales
    container_name: gh-sales
    ports:
      - "8083:8083"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8083

  user-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: user
    container_name: gh-user
    ports:
      - "8082:8082"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8082

  notification-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: notification
    container_name: gh-notification
    ports:
      - "8087:8087"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8087

  purchases-service:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: purchases
    container_name: gh-purchases
    ports:
      - "8086:8086"
    networks:
      - gh-network
    depends_on:
      - redis
      - kafka
    env_file: .env
    environment:
      SERVER_PORT: 8086

  # === Infrastructure ===
  redis:
    image: redis:7-alpine
    container_name: gh-redis
    ports:
      - "6379:6379"
    networks:
      - gh-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: gh-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      # localhost -> kafka 로 수정 (컨테이너 간 통신을 위해 필수)
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
    networks:
      - gh-network