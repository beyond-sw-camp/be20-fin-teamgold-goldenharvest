version: '3.8'

services:
  # --- Infrastructure ---
  redis:
    image: redis:7-alpine
    container_name: gh-redis
    ports:
      - "6379:6379"

  kafka:
    image: bitnami/kafka:3.6
    container_name: gh-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@localhost:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER

  # --- Frontend (Vite) ---
  frontend:
    build: ./apps/frontend
    container_name: gh-frontend
    ports:
      - "5173:5173"
    env_file: .env

  # --- Spring Boot Services ---
  api-gateway:
    build: ./apps/api-gateway
    container_name: gh-api-gateway
    ports:
      - "8080:8080"
    environment: &common-env
      SPRING_PROFILES_ACTIVE: local
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_REDIS_HOST: redis
      SERVER_PORT: 8080 # 각 서비스 하단에서 오버라이드
    env_file: .env
    depends_on: [kafka, redis]

  auth-service:
    build: ./apps/auth
    container_name: gh-auth
    ports:
      - "8081:8081"
    environment:
      <<: *common-env
      SERVER_PORT: 8081
    env_file: .env
    depends_on: [kafka, redis]

  user-service:
    build: ./apps/user
    container_name: gh-user
    ports:
      - "8082:8082"
    environment:
      <<: *common-env
      SERVER_PORT: 8082
    env_file: .env
    depends_on: [kafka, redis]

  sales-service:
    build: ./apps/sales
    container_name: gh-sales
    ports:
      - "8083:8083"
    environment:
      <<: *common-env
      SERVER_PORT: 8083
    env_file: .env
    depends_on: [kafka, redis]

  inventory-service:
    build: ./apps/inventory
    container_name: gh-inventory
    ports:
      - "8084:8084"
    environment:
      <<: *common-env
      SERVER_PORT: 8084
    env_file: .env
    depends_on: [kafka, redis]

  master-data-service:
    build: ./apps/master-data
    container_name: gh-master-data
    ports:
      - "8085:8085"
    environment:
      <<: *common-env
      SERVER_PORT: 8085
    env_file: .env
    depends_on: [kafka, redis]

  purchases-service:
    build: ./apps/purchases
    container_name: gh-purchases
    ports:
      - "8086:8086"
    environment:
      <<: *common-env
      SERVER_PORT: 8086
    env_file: .env
    depends_on: [kafka, redis]

  notification-service:
    build: ./apps/notification
    container_name: gh-notification
    ports:
      - "8087:8087"
    environment:
      <<: *common-env
      SERVER_PORT: 8087
    env_file: .env
    depends_on: [kafka, redis]

  customer-support-service:
    build: ./apps/customer-support
    container_name: gh-customer-support
    ports:
      - "8088:8088"
    environment:
      <<: *common-env
      SERVER_PORT: 8088
    env_file: .env
    depends_on: [kafka, redis]

networks:
  default:
    name: gh-network
