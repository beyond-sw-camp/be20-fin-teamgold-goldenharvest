services:
  # --- Infrastructure ---
  redis:
    image: redis:7-alpine
    container_name: gh-redis
    ports: ["6379:6379"]

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: gh-kafka
    ports: ["9092:9092"]
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@localhost:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER

  # --- Frontend & AI (독립 빌드) ---
  frontend:
    build: ./apps/frontend
    container_name: gh-frontend
    ports: ["5173:5173"]
    env_file: .env

  # --- Spring Boot Services (통합 Dockerfile 및 개별 포트 적용) ---
  api-gateway:
    build: &spring-build
      context: .
      dockerfile: ./Dockerfile
      args:
        SERVICE_NAME: api-gateway
    container_name: gh-api-gateway
    depends_on: [kafka, redis]
    ports: ["8080:8080"]
    environment: &common-env
      SPRING_PROFILES_ACTIVE: local
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_REDIS_HOST: redis
      SERVER_PORT: 8080
    env_file: .env

  auth-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: auth }
    container_name: gh-auth
    depends_on: [kafka, redis]
    ports: ["8081:8081"]
    environment:
      <<: *common-env
      SERVER_PORT: 8081
    env_file: .env

  user-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: user }
    container_name: gh-user
    depends_on: [kafka, redis]
    ports: ["8082:8082"]
    environment:
      <<: *common-env
      SERVER_PORT: 8082
    env_file: .env

  sales-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: sales }
    container_name: gh-sales
    depends_on: [kafka, redis]
    ports: ["8083:8083"]
    environment:
      <<: *common-env
      SERVER_PORT: 8083
    env_file: .env

  inventory-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: inventory }
    container_name: gh-inventory
    depends_on: [kafka, redis]
    ports: ["8084:8084"]
    environment:
      <<: *common-env
      SERVER_PORT: 8084
    env_file: .env

  master-data-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: master-data }
    container_name: gh-master-data
    depends_on: [kafka, redis]
    ports: ["8085:8085"]
    environment:
      <<: *common-env
      SERVER_PORT: 8085
    env_file: .env

  purchases-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: purchases }
    container_name: gh-purchases
    depends_on: [kafka, redis]
    ports: ["8086:8086"]
    environment:
      <<: *common-env
      SERVER_PORT: 8086
    env_file: .env

  notification-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: notification }
    container_name: gh-notification
    depends_on: [kafka, redis]
    ports: ["8087:8087"]
    environment:
      <<: *common-env
      SERVER_PORT: 8087
    env_file: .env

  customer-support-service:
    build:
      <<: *spring-build
      args: { SERVICE_NAME: customer-support }
    container_name: gh-customer-support
    depends_on: [kafka, redis]
    ports: ["8088:8088"]
    environment:
      <<: *common-env
      SERVER_PORT: 8088
    env_file: .env

networks:
  default:
    name: gh-network